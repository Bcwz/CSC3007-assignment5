<!DOCTYPE html>
  
<html>
    <head>
      <title>Assignment 5</title>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
      <script src="https://cdn.onemap.sg/leaflet/onemap-leaflet.js"></script>
    </head>
    <body onload="fetchPsi()">
      <h1>Singapore live PSI readings. (PSI categories is made up.)</h1>
      <div id='mapdiv' style='height:800px;'></div>
    </body>
    <style>
        .circle{
            height: 25px;
            width: 25px;
            border-radius: 50%;
            display: inline-block;
        }
    </style>
  <script>
    
    var center = L.bounds([1.56073, 104.11475], [1.16, 103.502]).getCenter();
    var map = L.map('mapdiv').setView([center.x, center.y], 12);

    var basemap = L.tileLayer('https://maps-{s}.onemap.sg/v3/Grey/{z}/{x}/{y}.png', {
        detectRetina: true,
        maxZoom: 18,
        minZoom: 11,
        //Do not remove this attribution
        attribution: '<img src="https://www.onemap.gov.sg/docs/maps/images/oneMap64-01.png" style="height:20px;width:20px;"/> OneMap | Map data &copy; contributors, <a href="http://SLA.gov.sg">Singapore Land Authority</a>'
    });    


    map.setMaxBounds([[1.56073, 104.1147], [1.16, 103.502]]);

    basemap.addTo(map);
    

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition);
      } 
    }

    function showPosition(position) {           
      marker = new L.Marker([position.coords.latitude, position.coords.longitude], {bounceOnAdd: false}).addTo(map);             
      var popup = L.popup()
      .setLatLng([position.coords.latitude, position.coords.longitude]) 
      .setContent('You are here!')
      .openOn(map);         
    }

    async function fetchPsi(){
        let psiURL = "https://api.data.gov.sg/v1/environment/psi";
        let response = await fetch(psiURL);
        let data = await response.json();
        //console.log(data.items[0].readings['psi_twenty_four_hourly']['west'])
        //console.log(data.region_metadata)
        let coordinates = JSON.parse(JSON.stringify(data.region_metadata));
        
        westLat = coordinates[0].label_location.latitude;
        westLong = coordinates[0].label_location.longitude;
        westPsi = data.items[0].readings['psi_twenty_four_hourly']['west'];
        //console.log(westLat, westLong, westPsi)
        var westCircle = L.circleMarker([westLat, westLong], {radius: 100}).addTo(map);
        westCircle.setStyle({color:colorRange(westPsi)})
        westCircle.on('click',function onPopUpClick(e) {
            var popup = L.popup()
            popup
                .setLatLng(e.latlng)
                .setContent("[West] Current PSI value is: " + westPsi + ". " + "<br>PSI category is: "+ riskLevel(westPsi))
                .openOn(map);
        })
        

        nationalLat = coordinates[1].label_location.latitude;
        nationalLong = coordinates[1].label_location.longitude;
        nationalPsi = data.items[0].readings['psi_twenty_four_hourly']['national'];
        var nationalCircle = L.circleMarker([nationalLat, nationalLong], {radius: 100}).addTo(map);
        nationalCircle.setStyle({color:colorRange(nationalPsi)})
        nationalCircle.on('click',function onPopUpClick(e) {
            var popup = L.popup()
            popup
                .setLatLng(e.latlng)
                .setContent("[National] Current PSI value is: " + nationalPsi + ". " + "<br>PSI category is: "+ riskLevel(nationalPsi))
                .openOn(map);
        })

        eastLat = coordinates[2].label_location.latitude;
        eastLong = coordinates[2].label_location.longitude;
        eastPsi = data.items[0].readings['psi_twenty_four_hourly']['east'];
        var eastCircle = L.circleMarker([eastLat, eastLong], {radius: 100}).addTo(map);
        eastCircle.setStyle({color:colorRange(eastPsi)})
        eastCircle.on('click',function onPopUpClick(e) {
            var popup = L.popup()
            popup
                .setLatLng(e.latlng)
                .setContent("[East] Current PSI value is: " + eastPsi + ". " + "<br>PSI category is: "+ riskLevel(eastPsi))
                .openOn(map);
        })

        centralLat = coordinates[3].label_location.latitude;
        centralLong = coordinates[3].label_location.longitude;
        centralPsi = data.items[0].readings['psi_twenty_four_hourly']['central'];
        var centralCircle = L.circleMarker([centralLat, centralLong], {radius: 100}).addTo(map);
        centralCircle.setStyle({color:colorRange(centralPsi)})
        centralCircle.on('click',function onPopUpClick(e) {
            var popup = L.popup()
            popup
                .setLatLng(e.latlng)
                .setContent("[Central] Current PSI value is: " + centralPsi + ". " + "<br>PSI category is: "+ riskLevel(centralPsi))
                .openOn(map);
        })

        southLat = coordinates[4].label_location.latitude;
        southLong = coordinates[4].label_location.longitude;
        southPsi = data.items[0].readings['psi_twenty_four_hourly']['south'];
        var southCircle = L.circleMarker([southLat, southLong], {radius: 100}).addTo(map);
        southCircle.setStyle({color:colorRange(southPsi)})
        southCircle.on('click',function onPopUpClick(e) {
            var popup = L.popup()
            popup
                .setLatLng(e.latlng)
                .setContent("[South] Current PSI value is: " + southPsi + ". " + "<br>PSI category is: "+ riskLevel(southPsi))
                .openOn(map);
        })

        northLat = coordinates[5].label_location.latitude;
        northLong = coordinates[5].label_location.longitude;
        northPsi = data.items[0].readings['psi_twenty_four_hourly']['north'];
        var northCircle = L.circleMarker([northLat, northLong], {radius: 100}).addTo(map);
        northCircle.setStyle({color:colorRange(northPsi)})
        console.log(colorRange(northPsi))
        northCircle.on('click',function onPopUpClick(e) {
            var popup = L.popup()
            popup
                .setLatLng(e.latlng)
                .setContent("[North] Current PSI value is: " + northPsi + ". " + "<br>PSI category is: "+ riskLevel(northPsi))
                .openOn(map);
        })

        var legend = L.control({position: 'bottomleft'});
        legend.onAdd = function (map) {
            var div = L.DomUtil.create('div', 'info legend');
            labels = ['<strong>PSI Categories</strong>'],
            categories = ['Very Healthy PSI','Healthy PSI','Moderate PSI','Unhealthy PSI','Very unhealthy PSI','Dangerous PSI'];

            for (var i = 0; i < categories.length; i++) {
                    div.innerHTML += 
                    labels.push(
                        '<i class="circle" style="background-color:' + getColor(categories[i]) + '"></i> ' +
                    (categories[i] ? categories[i] : '+'));

                }
                div.innerHTML = labels.join('<br>');
            return div;
            };
        legend.addTo(map);
    }

    function getColor(d) {
        if(d==="Very Healthy PSI"){
            return "#2E7F18"
        }else if(d === "Healthy PSI"){
            return "#45731E"
        }else if(d === "Moderate PSI"){
            return "#675E24"
        }else if(d === "Unhealthy PSI"){
            return "#8D472B"
        }else if(d === "Very unhealthy PSI"){
            return '#B13433'
        }else{
            return '#C82538'
        }
    }

    function style(feature) {
        return {
            weight: 1.5,
            opacity: 1,
            fillOpacity: 1,
            radius: 6,
            fillColor: getColor(feature.properties.TypeOfIssue),
            color: "grey"

        };
    }


    function colorRange(psiValue){
        //console.log(psiValue)
        if(psiValue < 35){
            return '#2E7F18'
        }else if(psiValue >= 35 && psiValue < 40){
            return "#45731E"
        }else if(psiValue >= 40 && psiValue < 45){
            return "#675E24"
        }else if(psiValue >= 45 && psiValue < 50){
            return "#8D472B"
        }else if(psiValue >= 50 && psiValue < 55){
            return '#B13433'
        }else{
            return '#C82538'
        }
        
    }

    function riskLevel(psiValue){
        //console.log(psiValue)
        if(psiValue < 35){
            return 'Very Healthy'
        }else if(psiValue >= 35 && psiValue < 40){
            return "Healthy"
        }else if(psiValue >= 40 && psiValue < 45){
            return "Moderate"
        }else if(psiValue >= 45 && psiValue < 50){
            return "Unhealthy"
        }else if(psiValue >= 50 && psiValue < 55){
            return 'Very unhealthy'
        }else{
            return 'Dangerous'
        }
        
    }

    function onPopUpClick(e) {
        var popup = L.popup()
        popup
            .setLatLng(e.latlng)
            .setContent("You clicked the map at " + e.latlng.toString())
            .openOn(map);
    }
  </script>
  </html>

